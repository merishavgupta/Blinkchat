<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlinkChat - Friendly Anonymous Chat</title>
  <meta name="description" content="BlinkChat — anonymous, friendly, moderated chats. No explicit content, no personal info sharing. Connect instantly with new people.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { background: linear-gradient(135deg,#0f1724 0%,#0b1220 100%); color:#e6eef8; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; min-height:100vh; margin:0; display:flex; flex-direction:column; }
    .neon-text { text-shadow:0 0 5px #6ee7b7,0 0 10px #6ee7b7; }
    .neon-border { box-shadow:0 0 10px rgba(110,231,183,0.18),0 0 20px rgba(110,231,183,0.08); }
    .chat-bubble { max-width:70%; padding:10px 15px; border-radius:15px; margin-bottom:10px; line-height:1.4; animation:fadeIn .25s ease; word-break:break-word; }
    .chat-bubble.self { background:#6ee7b7; color:#071029; align-self:flex-end; }
    .chat-bubble.other { background:#1f2937; color:#e6eef8; align-self:flex-start; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(8px)} to {opacity:1; transform:none} }
    .chat-container { height: calc(100vh - 120px); display:flex; flex-direction:column; }
    .typing-indicator { display:flex; align-items:center; font-size:.8rem; color:#a0aab4; margin-top:-10px; }
    .typing-indicator span { animation: blink 1s infinite; display:inline-block; }
    .typing-indicator span:nth-child(2){ animation-delay:.2s } .typing-indicator span:nth-child(3){ animation-delay:.4s }
    @keyframes blink { 0%,100%{opacity:.2} 50%{opacity:1} }
    input, select, button { transition:all .18s ease; }
    button:hover { transform:translateY(-2px); }
  </style>
</head>
<body>
  <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-[#071029] p-8 rounded-lg max-w-md w-11/12 neon-border">
      <h2 id="siteTitle" class="text-2xl font-bold text-center mb-4 neon-text">BlinkChat</h2>
      <p class="text-center text-gray-300 mb-4">Friendly, anonymous chats. No explicit content. Do not share personal information.</p>

      <div class="mb-4">
        <label class="block text-gray-300 mb-2">Username</label>
        <input id="username" type="text" class="w-full py-2 px-4 bg-[#0f1724] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6ee7b7]" placeholder="Choose username (3-20 chars)">
        <p id="usernameStatus" class="text-sm mt-1 hidden"></p>
      </div>

      <div class="mb-4">
        <label class="block text-gray-300 mb-2">Gender (optional)</label>
        <select id="gender" class="w-full py-2 px-4 bg-[#0f1724] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6ee7b7]">
          <option value="">Prefer not to say</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="mb-2 text-xs text-gray-400">
        By joining you accept our <a href="/terms.html" class="text-[#6ee7b7] underline">Terms</a> and <a href="/privacy.html" class="text-[#6ee7b7] underline">Privacy Policy</a>. No explicit content allowed. Sharing phone/email is blocked.
      </div>

      <button id="startChat" class="w-full mt-4 py-3 bg-[#6ee7b7] text-[#071029] font-bold rounded-lg hover:opacity-95">Start Chatting</button>
    </div>
  </div>

  <div id="chatScreen" class="hidden flex flex-col h-screen">
    <header class="p-4 border-b border-gray-700 flex justify-between items-center">
      <h1 class="text-2xl font-bold neon-text" id="headerTitle">BlinkChat</h1>
      <div class="flex space-x-2">
        <button id="nextPerson" class="px-4 py-2 bg-[#6ee7b7] text-[#071029] font-semibold rounded-lg">Next Person</button>
        <button id="reportUser" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg">Report</button>
      </div>
    </header>

    <div class="flex-1 p-4 overflow-hidden flex flex-col chat-container">
      <div id="status" class="text-center text-gray-400 mb-4">Connecting to a random person...</div>
      <div id="chatMessages" class="flex-1 overflow-y-auto pr-1 flex flex-col"></div>
      <div id="typingIndicator" class="typing-indicator hidden"><span>.</span><span>.</span><span>.</span> Typing</div>

      <div class="mt-2 flex">
        <input id="messageInput" type="text" class="flex-1 py-3 px-4 bg-[#0f1724] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6ee7b7]" placeholder="Type a friendly message...">
        <button id="sendMessage" class="px-6 py-3 bg-[#6ee7b7] text-[#071029] font-bold rounded-lg ml-2">Send</button>
      </div>
    </div>

    <footer class="p-4 text-center text-gray-500 text-sm">
      <p id="footerText">BlinkChat &copy; <span id="year"></span> | <a href="/privacy.html" class="text-[#6ee7b7] underline">Privacy</a></p>
    </footer>
  </div>

  <div id="safetyModal" class="fixed inset-0 bg-black bg-opacity-80 items-center justify-center z-50 hidden">
    <div class="bg-[#071029] p-8 rounded-lg max-w-md w-11/12 neon-border overflow-y-auto max-h-[80vh]">
      <h2 class="text-2xl font-bold text-center mb-4 neon-text">Safety Guidelines</h2>
      <ul class="list-disc pl-5 space-y-2 text-gray-300">
        <li>Do not share phone numbers, emails, addresses, or social profiles.</li>
        <li>Be respectful — abusive or explicit content is prohibited.</li>
        <li>Report misuse so moderators can review.</li>
        <li>Sessions are ephemeral and logs are minimized.</li>
        <li>If uncomfortable, click "Next Person".</li>
      </ul>
      <button id="closeSafety" class="w-full mt-6 py-3 bg-[#6ee7b7] text-[#071029] font-bold rounded-lg">Got It</button>
    </div>
  </div>

<script>
  const SITE_NAME = 'BlinkChat';
  const setupModal = document.getElementById('setupModal');
  const chatScreen = document.getElementById('chatScreen');
  const usernameInput = document.getElementById('username');
  const usernameStatus = document.getElementById('usernameStatus');
  const startChatBtn = document.getElementById('startChat');
  const messageInput = document.getElementById('messageInput');
  const sendMessageBtn = document.getElementById('sendMessage');
  const chatMessages = document.getElementById('chatMessages');
  const status = document.getElementById('status');
  const nextPersonBtn = document.getElementById('nextPerson');
  const reportUserBtn = document.getElementById('reportUser');
  const safetyLink = document.getElementById('safetyLink');
  const safetyModal = document.getElementById('safetyModal');
  const closeSafetyBtn = document.getElementById('closeSafety');
  const typingIndicator = document.getElementById('typingIndicator');
  document.getElementById('year').textContent = new Date().getFullYear();
  document.getElementById('siteTitle').textContent = SITE_NAME;
  document.getElementById('headerTitle').textContent = SITE_NAME;
  document.getElementById('footerText').childNodes[0].textContent = SITE_NAME + ' \u00A0 ';

  let socket;
  let currentUsername = '';
  let isConnected = false;
  let typingTimeout;

  usernameInput.addEventListener('input', () => {
    const username = usernameInput.value.trim();
    if (username.length < 3 || username.length > 20) {
      usernameStatus.classList.add('hidden');
      return;
    }
    setTimeout(() => {
      const forbidden = ['admin','moderator','system'];
      if (forbidden.includes(username.toLowerCase())) {
        usernameStatus.textContent = 'Username not allowed';
        usernameStatus.className = 'text-sm mt-1 text-red-400';
      } else {
        usernameStatus.textContent = 'Looks good';
        usernameStatus.className = 'text-sm mt-1 text-green-400';
      }
    }, 200);
  });

  const bannedWords = ['explicitword1','explicitword2','porn','sex','nude','xxx'];
  function containsBannedWord(text) {
    const t = (text||'').toLowerCase();
    for (const w of bannedWords) if (w && t.includes(w)) return true;
    return false;
  }
  function containsPII(text) {
    const phone = /(\+?\d{10,15})|(\d{3}[-.\s]\d{3}[-.\s]\d{4})/;
    const email = /[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/;
    return phone.test(text) || email.test(text);
  }

  startChatBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (username.length < 3) { alert('Choose a username with 3 or more characters.'); return; }
    if (!/^[A-Za-z0-9_.-]{3,20}$/.test(username)) { alert('Username can contain letters, numbers, ., _, - only.'); return; }
    currentUsername = username;
    setupModal.classList.add('hidden');
    chatScreen.classList.remove('hidden');
    initSocket();
  });

  function initSocket() {
    socket = io();

    socket.on('connect', () => {
      status.textContent = 'Connected. Finding a chat partner...';
      isConnected = true;
      socket.emit('join', { username: currentUsername, gender: document.getElementById('gender').value });
    });
    socket.on('disconnect', () => { status.textContent = 'Disconnected. Reconnecting...'; isConnected = false; });
    socket.on('partnerFound', (partner) => { const label = partner && partner.gender ? ` (${partner.gender})` : ''; status.textContent = `Chatting with someone${label}`; });
    socket.on('message', (data) => { addMessageToChat(data.message, false); typingIndicator.classList.add('hidden'); });
    socket.on('system', (msg) => { addMessageToChat(msg, false, true); });
    socket.on('typing', () => { typingIndicator.classList.remove('hidden'); clearTimeout(typingTimeout); typingTimeout = setTimeout(()=>typingIndicator.classList.add('hidden'),2000); });
    socket.on('partnerDisconnected', () => { status.textContent = 'Partner disconnected. Finding new partner...'; addMessageToChat('Partner has left the chat.', false, true); });
  }

  function addMessageToChat(message, isSelf, isSystem=false) {
    const d = document.createElement('div'); d.className = isSelf ? 'chat-bubble self' : 'chat-bubble other';
    d.textContent = isSystem ? message : (isSelf ? 'You: ' : 'Stranger: ') + message;
    chatMessages.appendChild(d); chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendMessageBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });
  messageInput.addEventListener('input', ()=>{ if(socket && isConnected) socket.emit('typing'); });

  function sendMessage(){
    const message = messageInput.value.trim(); if(!message) return;
    if (containsBannedWord(message)) { alert('Please keep conversation respectful.'); return; }
    if (containsPII(message)) { alert('Sharing phone/email is not allowed. Remove personal info before sending.'); return; }
    if(socket && isConnected){ socket.emit('message', { message }); addMessageToChat(message, true); messageInput.value=''; } else alert('Not connected to server yet.');
  }

  nextPersonBtn.addEventListener('click', ()=>{ if(socket){ socket.emit('nextPerson'); status.textContent='Finding a new chat partner...'; chatMessages.innerHTML=''; } });
  reportUserBtn.addEventListener('click', ()=>{ if(socket && isConnected){ socket.emit('report', { reason:'user_reported' }); alert('Reported. Moderation will review. Moving to next person.'); socket.emit('nextPerson'); status.textContent='Finding a new chat partner...'; chatMessages.innerHTML=''; } });

  document.addEventListener('DOMContentLoaded', ()=> usernameInput.focus());
</script>
</body>
</html>