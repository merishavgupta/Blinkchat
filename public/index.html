<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlinkChat — Anonymous Chat</title>

  <!-- Tailwind CDN for quick responsive styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ====== Safety & interaction fixes + UI styles ====== -->
  <style>
    /* ===== Interaction / overlay fixes (important) ===== */
    /* Prevent accidental overlay from blocking taps and ensure controls get taps */
    html, body { -webkit-tap-highlight-color: transparent; }
    input, select, button, .btn, .chat-input {
      position: relative !important;
      z-index: 9999 !important;
      pointer-events: auto !important;
    }
    /* If any large overlay exists accidentally, make it non-interactive (temporary safety) */
    .overlay, .modal, .age-overlay, .invisible-block {
      pointer-events: none !important;
    }
    /* But keep actual modal children interactive */
    .modal * , .age-overlay * { pointer-events: auto !important; z-index:10000 !important; }

    /* ===== Visual styles ===== */
    .neon {
      text-shadow: 0 0 6px rgba(16,185,129,0.95), 0 0 12px rgba(16,185,129,0.6);
    }
    .bubble {
      max-width: 86%;
      word-wrap: break-word;
      line-height: 1.3;
      border-radius: 0.6rem;
    }
    .scroll { scrollbar-width: thin; }
    @media (max-width:420px){
      .chat-input { font-size: 15px; }
      .form-input { font-size: 15px; padding:.6rem .75rem; }
      .btn { font-size: 15px; padding:.55rem .9rem; }
    }

    /* small nicety to avoid input outlines on mobile focusing uglily */
    input:focus, select:focus, button:focus { outline: none; box-shadow: 0 0 0 3px rgba(16,185,129,0.12); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 text-slate-100 antialiased">

  <div class="max-w-xl mx-auto p-4">
    <!-- header -->
    <header class="mb-4 text-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold neon">BlinkChat</h1>
      <p class="text-sm text-slate-300 mt-1">Friendly anonymous chats — no personal info. </p>
    </header>

    <!-- Age modal simplified inline for fast use (still requires confirm) -->
    <div id="ageSection" class="bg-slate-900/60 border border-slate-700 rounded-lg p-4 mb-4 modal">
      <p class="text-sm text-slate-300 mb-3">You must be 18+ to use BlinkChat. By continuing you accept our Terms & Privacy Policy.</p>
      <label class="flex items-center gap-3">
        <input id="ageConfirm" type="checkbox" class="form-checkbox h-5 w-5 accent-emerald-400">
        <span class="text-sm">I confirm I am 18 or older</span>
      </label>
      <button id="ageEnter" class="mt-3 w-full btn bg-emerald-400 text-slate-900 font-semibold rounded-md py-2 disabled:opacity-60" disabled>Continue</button>
    </div>

    <!-- Setup / profile card -->
    <div id="setup" class="hidden bg-slate-900/50 border border-slate-700 rounded-lg p-4 mb-4 space-y-3">
      <label class="block text-sm">Choose a username</label>
      <input id="username" class="form-input w-full rounded-md bg-slate-800 border border-slate-700 p-3" placeholder="e.g. Raju123" minlength="3" />

      <div class="flex gap-2">
        <div class="flex-1">
          <label class="block text-sm">Gender (optional)</label>
          <select id="gender" class="form-input w-full rounded-md bg-slate-800 border border-slate-700 p-3">
            <option value="unspecified">Unspecified</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="w-28">
          <label class="block text-sm">Age</label>
          <input id="age" type="number" min="18" max="100" value="18" class="form-input w-full rounded-md bg-slate-800 border border-slate-700 p-3 text-center" />
        </div>
      </div>

      <button id="startChat" class="w-full btn bg-emerald-400 text-slate-900 font-semibold rounded-md py-2">Start Chatting</button>
    </div>

    <!-- Chat screen -->
    <main id="chatScreen" class="hidden flex flex-col h-[65vh]">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="font-semibold">Connected to: <span id="partnerName" class="text-emerald-300">—</span></h2>
        <div class="flex gap-2">
          <button id="nextPerson" class="btn bg-emerald-500 text-slate-900 rounded-md px-3 py-1">Next</button>
          <button id="reportUser" class="btn bg-rose-600 text-white rounded-md px-3 py-1">Report</button>
        </div>
      </div>

      <section class="flex-1 bg-slate-900/40 border border-slate-800 rounded-lg p-3 overflow-y-auto scroll">
        <div id="chatMessages" class="flex flex-col gap-3"></div>
      </section>

      <div class="mt-3 flex gap-2">
        <input id="messageInput" class="chat-input flex-1 rounded-md bg-slate-800 border border-slate-700 p-3" placeholder="Write a message..." />
        <button id="sendMessage" class="btn bg-emerald-400 text-slate-900 rounded-md px-4">Send</button>
      </div>
    </main>

    <footer class="mt-4 text-center text-xs text-slate-400">
      BlinkChat • Anonymous • Do not share personal details
    </footer>
  </div>

  <!-- socket.io client (keeps same) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

  <!-- ====== Client UI + socket logic (mobile-friendly) ====== -->
  <script>
    // Elements
    const ageConfirm = document.getElementById('ageConfirm');
    const ageEnter = document.getElementById('ageEnter');
    const ageSection = document.getElementById('ageSection');
    const setup = document.getElementById('setup');
    const chatScreen = document.getElementById('chatScreen');

    const usernameInput = document.getElementById('username');
    const startBtn = document.getElementById('startChat');
    const partnerName = document.getElementById('partnerName');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendMessage');
    const nextBtn = document.getElementById('nextPerson');
    const reportBtn = document.getElementById('reportUser');

    let socket, connected = false;

    // Age confirmation
    ageConfirm.addEventListener('change', ()=> ageEnter.disabled = !ageConfirm.checked);
    ageEnter.addEventListener('click', ()=> {
      if (ageConfirm.checked) {
        ageSection.classList.add('hidden');
        setup.classList.remove('hidden');
        // ensure focus doesn't jump to unexpected input
        setTimeout(()=> usernameInput.focus(), 200);
      }
    });

    // Start chat / validation
    startBtn.addEventListener('click', ()=> {
      const name = usernameInput.value.trim();
      if (!name || name.length < 3) { alert('Choose a username with 3+ characters'); return; }
      setup.classList.add('hidden');
      chatScreen.classList.remove('hidden');
      connectToServer(name);
    });

    function connectToServer(name) {
      // Use same origin (Render serves frontend+backend)
      const root = location.origin;
      socket = io(root);

      socket.on('connect', ()=> {
        connected = true;
        socket.emit('join', { username: name });
        addSystem('Connected. Finding a partner...');
      });

      socket.on('partnerFound', partner => {
        partnerName.textContent = partner.username || 'Stranger';
        addSystem('Partner found — say hi!');
      });

      socket.on('message', data => addMessage(data.message, false));
      socket.on('partnerDisconnected', ()=> addSystem('Partner left — finding another...'));
      socket.on('typing', ()=> addTempSystem('Typing…', 900));

      socket.on('disconnect', ()=> { connected=false; addSystem('Disconnected from server'); });
      socket.on('connect_error', (err) => addSystem('Connection error — retrying...'));
    }

    function addMessage(text, self) {
      const el = document.createElement('div');
      el.className = 'bubble p-3 rounded-lg ' + (self ? 'bg-emerald-300 text-slate-900 self-end' : 'bg-slate-700 text-slate-100 self-start');
      el.textContent = (self ? 'You: ' : '') + text;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addSystem(text) {
      const el = document.createElement('div');
      el.className = 'text-xs text-slate-400 italic';
      el.textContent = text;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTempSystem(text, ms=1000) {
      const el = document.createElement('div');
      el.className = 'text-xs text-slate-400 italic';
      el.textContent = text;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      setTimeout(()=> el.remove(), ms);
    }

    // Sending
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') sendMessage(); });

    function sendMessage(){
      const msg = messageInput.value.trim();
      if (!msg || !socket || !connected) return;
      socket.emit('message', { message: msg });
      addMessage(msg, true);
      messageInput.value = '';
    }

    // Next / report
    nextBtn.addEventListener('click', ()=> {
      if (socket && connected) {
        socket.emit('nextPerson');
        chatMessages.innerHTML = '';
        partnerName.textContent = '—';
        addSystem('Finding new partner...');
      }
    });

    reportBtn.addEventListener('click', ()=> {
      if (socket && connected) {
        socket.emit('report');
        addSystem('Reported user. Finding new partner...');
        socket.emit('nextPerson');
        chatMessages.innerHTML = '';
      }
    });

    // Safety: focus trap prevention (if some overlay steals focus)
    document.addEventListener('click', (e)=>{
      // if click lands on body and not an interactive control, don't focus hidden inputs
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
      if (!['input','button','select','textarea','a'].includes(tag)) return;
      // otherwise let normal interaction
    }, true);
  </script>
</body>
  </html>
